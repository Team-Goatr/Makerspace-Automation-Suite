<?php
    defined( 'ABSPATH' ) or die();
    echo '<link rel="stylesheet" type="text/css" href="' . plugins_url( 'member-page.css', __FILE__ ) . '">' . "\n";

    $admin_post = admin_url( 'admin-post.php' );

    require_once dirname(__DIR__).'/resources/GSuiteAPI.php';
    require_once dirname(__DIR__).'/resources/StripeAPI.php';

    $email = wp_get_current_user()->user_email;

    $user = getUser($email);
    $firstName = $user->getName()->getGivenName();
    $lastName = $user->getName()->getFamilyName();
    $personalEmail = $user->getEmails()[0]['address'];
    $sub_mgmt = $user->getCustomSchemas()['Subscription_Management'];
    $stripe_id = !empty($sub_mgmt['Stripe_ID']) ? $sub_mgmt['Stripe_ID'] : '';
    $dm_email = $user->getPrimaryEmail();


    $card;
    if (!empty($stripe_id)) {
        $card = getStripeCustomerCard($stripe_id);
    }
?>

<div>
    <div class="row">
        <div class="mas-title col-md-12">
            Welcome, <?php echo $user->getName()->getFullName(); ?>!        
        </div>
    </div>

    <div class="row">
        <!-- PICTURE, BUTTONS -->
        <div style="text-align: center" class="col-md-4">
            <?php echo '<img src="' . plugins_url( '../images/female-placeholder.png', __FILE__ ) . '" id="profilePic" alt="Profile Picture">' . "\n";
                    ?>
            <br>
            <button type="password" class="btn mas-button">Change Password</button>
        </div>

        <!-- PERSONAL INFO FORM -->
        <div style="text-align: center" class="col-md-4">
            <form name="userForm" method="POST" action="<?php echo admin_url( 'admin-post.php') ?>">
                <div class="form-group">
                    <label for="firstName">First Name</label>
                    <input name="firstName" class="form-control" value="<?php echo $firstName; ?>">
                </div>

                <div class="form-group">
                    <label for="lastName">Last Name</label>
                    <input name="lastName" class="form-control" value="<?php echo $lastName; ?>">
                </div>

                <div class="form-group">
                    <label for="inputEmail" class="control-label">Personal Email</label>
                    <input type="email" name="personalEmail" class="form-control" id="inputEmail" placeholder="Email" required value="<?php echo $personalEmail; ?>">
                </div>

                <div class="form-group">
                    <label class="dmEmail">DM Email</label>
                    <input type="text" class="form-control" id="username" value="<?php echo $dm_email; ?>" disabled>
                </div>

                <input type="hidden" name="action" value="update_self">

                <button type="submit" class="btn mas-button">Update Info</button>
            </form>
        </div>

        <!-- PAYMENT INFO -->
        <div style="text-align: center" class="panel panel-default col-md-4">

            <div class="panel-heading">
                <h3 class="panel-title mas-title">Card Details</h3>
            </div>

            <div class="panel-body">
                <form name="payment">
                    <div class="form-group">
                        <label for="cardNum">Last 4 Digits:</label>
                        <input type="card" name="cardNum" class="form-control" disabled value="****-****-****-<?php echo $card->last4; ?>">
                    </div>

                    <div class="form-group">
                        <label for="expirationDate">Expiration Date:</label>
                        <input required type="text" name="expirationDate" class="form-control" disabled value="<?php echo $card->exp_month."/".$card->exp_year; ?>" />
                    </div>

                    <div class="form-group">
                        <label for="cardBrand">Card Type:</label>
                        <input required type="brand" name="cardBrand" class="form-control" disabled value=" <?php echo $card->brand; ?>" />
                    </div>

                    <input type="hidden" value="<?php echo $stripe_id ?>" name="customer-id">
                    <input type="hidden" name="action" value="update_card">
                    <?php getStripeUpdateCard($personalEmail); ?>
                </form>
            </div>
        </div>
    </div>
</div>